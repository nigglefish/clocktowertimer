<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initital-scale=1.0"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Blood on the Clocktower Timer">
    <title>
        Blood on the Clocktower
    </title>
    <style>
        body {
            background-color: #000;
        }
        #clock {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vw;
            pointer-events: all;
        }

        #clock #face {
            position: relative;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #clock #big {
            position: absolute;
            left: calc(100% * 710 / 1620);
            top: calc(100% * 10 / 1620);
            width: calc(100% * 200 / 1620);
            height: calc(100% * 1000 / 1620);
            transform-origin: 50% 80%;
            transform: rotate(0deg);
        }
        #clock #small {
            position: absolute;
            left: calc(100% * 710 / 1620);
            top: calc(100% * 410 / 1620);
            width: calc(100% * 200 / 1620);
            height: calc(100% * 600 / 1620);
            transform-origin: 50% 66.66667%;
            transform: rotate(0deg);
        }
    </style>
</head>
<body>
    <div id="clock">
        <img id="face" src="face.png">
        <img id="big" src="big.png">
        <img id="small" src="small.png">
    </div>
    <script>
        let clock = document.getElementById('clock');
        let big = document.getElementById('big');
        let small = document.getElementById('small');
        let chime = new Audio('chime.mp3');
        let chimePlayed = false;
        let currentMinutes = 60;
        let intervalId = null;
        let dragging = false;

        function updateTimer(minutes) {
            currentMinutes = minutes;
            big.style.transform = 'rotate(' + (minutes * 6) + 'deg)';
            small.style.transform = 'rotate(' + (330 + minutes * 0.5) + 'deg)';
        }

        function setTimer(minutes) {
            let started = intervalId !== null;
            if(started) {
                stopTimer();
            }
            currentMinutes = minutes;
            updateTimer(minutes);
            if(started) {
                startTimer();
            }
        }

        function startTimer() {
            let startDate = new Date();
            let startMinutes = currentMinutes;
            updateTimer(startMinutes);
            clearInterval(intervalId);
            intervalId = setInterval(function() {
                let now = new Date();
                let elapsed = now - startDate;
                let minutes = startMinutes + 5 * elapsed / 60000; // Time moves 5 times faster.
                if(minutes >= 60) {
                    minutes = 60;
                    stopTimer();
                    chime.play();
                }
                updateTimer(minutes);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(intervalId);
            intervalId = null;
        }

        updateTimer(55);

        function onClick(event) {
            if(!chimePlayed) {
                chime.play();
                chime.pause();
                chimePlayed = true;
            }

            let boundedClickRect = clock.getBoundingClientRect();
            let x = ((event.clientX - boundedClickRect.left) * 2 / clock.clientWidth) - 1;
            let y = ((event.clientY - boundedClickRect.top) * 2 / clock.clientHeight) - 1;
            let radius = Math.sqrt(x*x + y*y);

            if(radius > 0.46 && radius < 0.715) {
                // Clicked in time:
                let minutes = ((Math.atan2(y, x) * 30 / Math.PI) + 75) % 60;
                setTimer(minutes);
            } else {
                // Clicked outside time: 
                if(intervalId === null) {
                    if(currentMinutes <= 60) {
                        startTimer();
                    }
                } else {
                    stopTimer();
                }
            }
            event.preventDefault();
        }

        clock.addEventListener('click', onClick);
 
    </script>
</body>
</html>