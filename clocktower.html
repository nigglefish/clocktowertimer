<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initital-scale=1.0"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Blood on the Clocktower Timer">
    <title>
        Blood on the Clocktower
    </title>
    <style>
        @font-face {
            font-family: OldLondon;
            src: url('OldLondon.ttf');
        }
        body {
            background-color: #000;
        }
        #clock {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vw;
        }
        #clock #face {
            position: relative;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #clock #big {
            position: absolute;
            left: calc(100% * 710 / 1620);
            top: calc(100% * 10 / 1620);
            width: calc(100% * 200 / 1620);
            height: calc(100% * 1000 / 1620);
            transform-origin: 50% 80%;
            transform: rotate(0deg);
        }
        #clock #small {
            position: absolute;
            left: calc(100% * 710 / 1620);
            top: calc(100% * 410 / 1620);
            width: calc(100% * 200 / 1620);
            height: calc(100% * 600 / 1620);
            transform-origin: 50% 66.66667%;
            transform: rotate(0deg);
        }
        #players {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100vw;
            height: calc(100vw * 400 / 1620);
            background: url("parchment.png");
            background-size: cover;
        }
        #players #grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            grid-gap: 2vw;
            position: absolute;
            left: 7vw;
            bottom: 5vw;
            width: 86vw;
            height: calc((100vw * 400 / 1620) - 10vw);
            --background-color: red;
        }
        #players #grid .number {
            grid-row: 1;
            font-size: 12vw;
            justify-self: center;
            align-self: start;
            font-family: OldLondon, serif;
            font-weight: bold;
        }
        #players #grid .label {
            grid-row: 1;
            font-size: 4vw;
            justify-self: center;
            align-self: end;
            font-family: OldLondon, serif;
        }
    </style>
</head>
<body>
    <div id="clock">
        <img id="face" src="face.png">
        <img id="big" src="big.png">
        <img id="small" src="small.png">
    </div>
    <div id="players">
        <div id="grid">
            <div class="number" id="player-count" style="grid-column:1; color:#222">99</div>
            <div class="number" id="townsfolk-count" style="grid-column:2; color:#008">2</div>
            <div class="number" id="outsider-count" style="grid-column:3; color:#008">1</div>
            <div class="number" id="minion-count" style="grid-column:4; color:#800">4</div>
            <div class="number" id="demon-count" style="grid-column:5; color:#800">1</div>

            <div class="label" id="player-label" style="grid-column:1; color:#222">Players</div>
            <div class="label" id="townsfolk-label" style="grid-column:2; color:#008">Townsfolk</div>
            <div class="label" id="outsider-label" style="grid-column:3; color:#008">Outsider</div>
            <div class="label" id="minion-label" style="grid-column:4; color:#800">Minion</div>
            <div class="label" id="demon-label" style="grid-column:5; color:#800">Demon</div>
        </div>
    </div>
    <script>
        let clock = document.getElementById('clock');
        let big = document.getElementById('big');
        let small = document.getElementById('small');
        let chime = new Audio('chime.mp3');
        let chimePlayed = false;
        let players = document.getElementById('players');
        let currentMinutes = 60;
        let intervalId = null;
        let dragging = false;
        let currentPlayers = 5;

        const PLAYER_NUMBERS = [
            [5, 3, 0, 1, 1],
            [6, 3, 1, 1, 1],
            [7, 5, 0, 1, 1],
            [8, 5, 1, 1, 1],
            [9, 5, 2, 1, 1],
            [10, 7, 0, 2, 1],
            [11, 7, 1, 2, 1],
            [12, 7, 2, 2, 1],
            [13, 9, 0, 3, 1],
            [14, 9, 1, 3, 1],
            [15, 9, 2, 3, 1],
        ];

        playerData = [
            [document.getElementById('player-count'), document.getElementById('player-label'), 'Player'],
            [document.getElementById('townsfolk-count'), document.getElementById('townsfolk-label'), 'Townsfolk'],
            [document.getElementById('outsider-count'), document.getElementById('outsider-label'), 'Outsider'],
            [document.getElementById('minion-count'), document.getElementById('minion-label'), 'Minion'],
            [document.getElementById('demon-count'), document.getElementById('demon-label'), 'Demon'],
        ];

        function updateTimer(minutes) {
            currentMinutes = minutes;
            big.style.transform = 'rotate(' + (minutes * 6) + 'deg)';
            small.style.transform = 'rotate(' + (330 + minutes * 0.5) + 'deg)';
        }

        function setTimer(minutes) {
            let started = intervalId !== null;
            if(started) {
                stopTimer();
            }
            currentMinutes = minutes;
            updateTimer(minutes);
            if(started) {
                startTimer();
            }
        }

        function startTimer() {
            let startDate = new Date();
            let startMinutes = currentMinutes;
            updateTimer(startMinutes);
            clearInterval(intervalId);
            intervalId = setInterval(function() {
                let now = new Date();
                let elapsed = now - startDate;
                let minutes = startMinutes + 5 * elapsed / 60000; // Time moves 5 times faster.
                if(minutes >= 60) {
                    minutes = 60;
                    stopTimer();
                    chime.play();
                }
                updateTimer(minutes);
            }, 100);
        }

        function stopTimer() {
            clearInterval(intervalId);
            intervalId = null;
        }

        function onClockClick(event) {
            if(!chimePlayed) {
                chime.play();
                chime.pause();
                chimePlayed = true;
            }

            let boundedClickRect = clock.getBoundingClientRect();
            let x = ((event.clientX - boundedClickRect.left) * 2 / clock.clientWidth) - 1;
            let y = ((event.clientY - boundedClickRect.top) * 2 / clock.clientHeight) - 1;
            let radius = Math.sqrt(x*x + y*y);

            if(radius > 0.46 && radius < 0.715) {
                // Clicked in time:
                let minutes = ((Math.atan2(y, x) * 30 / Math.PI) + 75) % 60;
                setTimer(minutes);
            } else {
                // Clicked outside time: 
                if(intervalId === null) {
                    if(currentMinutes <= 60) {
                        startTimer();
                    }
                } else {
                    stopTimer();
                }
            }
            event.preventDefault();
        }

        function setPlayers(number) {
            if(number < 5) {
                number = 5;
            } else if(number > 15) {
                number = 15;
            }
            currentPlayers = number;
            let numbers = PLAYER_NUMBERS[number - 5];
            for(let i = 0; i < 5; i++) {
                let [count, label, text] = playerData[i];
                let number = numbers[i];
                count.innerHTML = number;
                if(number !== 1 & i !== 1) {
                    text += 's';
                }
                label.innerHTML = text;
            }
        }

        function onPlayersClick() {
            let number = currentPlayers + 1;
            if(number === 16) {
                number = 5;
            }
            setPlayers(number);
        }

        clock.addEventListener('click', onClockClick);
        players.addEventListener('click', onPlayersClick);

        updateTimer(60);
        setPlayers(5);
 
    </script>
</body>
</html>